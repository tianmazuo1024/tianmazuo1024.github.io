import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as t,c as n,a as e,e as a,b as r,w as l,d as o,o as h}from"./app-B5m7CcSj.js";const p={},k=e("h2",{id:"jvm参数调优",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#jvm参数调优"},[e("span",null,"JVM参数调优")])],-1),d=e("p",null,[e("a",{href:"https://kafka.apache.org/",target:"_blank",rel:"noopener noreferrer"},"Kafka"),a("的"),e("code",null,"Broker"),a("进程默认使用"),e("code",null,"1GB"),a("内存。")],-1),c=e("a",{href:"https://zh.wikipedia.org/wiki/Java%E8%99%9A%E6%8B%9F%E6%9C%BA",target:"_blank",rel:"noopener noreferrer"},"JVM",-1),g=e("code",null,"《第4章 JVM GC》",-1),m=o(`<p>知道如何调整和优化<a href="https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html" target="_blank" rel="noopener noreferrer">JVM GC</a>之后，就可以来修改<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>的<a href="https://zh.wikipedia.org/wiki/Java%E8%99%9A%E6%8B%9F%E6%9C%BA" target="_blank" rel="noopener noreferrer">JVM</a>参数了。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd /home/work/kafka_2.12-3.7.1/bin</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi kafka-server-start.sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 调整下面的JVM参数就行了</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> KAFKA_HEAP_OPTS</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;-Xmx1G -Xms1G&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这需要根据具体的业务场景和<a href="https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html" target="_blank" rel="noopener noreferrer">JVM GC</a>压测结果来综合调整。</p><br><h2 id="副本参数调忧" tabindex="-1"><a class="header-anchor" href="#副本参数调忧"><span>副本参数调忧</span></a></h2><p>这里主要调整两个参数。</p><ul><li><p><code>replica.socket.timeout.ms</code>：这个参数用于控制不同的<code>Partition</code>之间<a href="https://en.wikipedia.org/wiki/Network_socket" target="_blank" rel="noopener noreferrer">Socket</a>通信的超时时间，它默认值是30秒，可以根据实际网络情况调整。</p></li><li><p><code>replica.lag.time.max.ms</code>：这个参数用于当某个副本没有向其<code>Leader</code>节点发送任何请求，或者在指定时间内没有同步完成<code>Leader</code>节点中的数据的话，那么<code>Leader</code>会将这个节点从它的<code>ISR</code>列表中删除，它的默认值是10秒，可以根据实际网络情况调整。如果这个参数值太小，会让<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>陷入不停复制副本的恶性循环。</p></li></ul><br><h2 id="log参数调优" tabindex="-1"><a class="header-anchor" href="#log参数调优"><span>Log参数调优</span></a></h2><p>这里的<code>Log</code>并不是指的日志，而是<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>的数据清除时机，主要就是<code>log.retention.hours=24</code>这个参数，它的默认值为7天，极其浪费磁盘存储空间。</p><p>而且一般在生产环境中，会把<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>的数据清洗后保存到<a href="https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HdfsDesign.html" target="_blank" rel="noopener noreferrer">HDFS</a>，所以没有必要保留那么久。</p><br><h2 id="topic命名" tabindex="-1"><a class="header-anchor" href="#topic命名"><span>Topic命名</span></a></h2><p>除了指定明确的业务名称，可以给<code>Topic</code>的名称加一些后缀，例如<code>order_paying_r3p5</code>。</p><p>其中<code>r3p5</code>表示这个<code>Topic</code>创建时，给它指定的<code>--replication-factor</code>（副本因子）为3，而<code>--partitions</code>（分区的数量）为5。</p><p>这样的好处在于消费数据时就可以知道需要设置多少个<code>Consumer</code>去消费效率会最高（两者数量保持一致，一一对应的情况下效率最高）。</p><p>但如果动态调整了<code>Topic</code>的<code>Partition</code>数量，那这个名称就可能会产生误导了。</p><br><h2 id="监控工具" tabindex="-1"><a class="header-anchor" href="#监控工具"><span>监控工具</span></a></h2><p><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer">Apache官方</a>并没有提供<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>的<code>Web UI</code>管理工具，但可以通过开源项目<a href="https://github.com/yahoo/CMAK" target="_blank" rel="noopener noreferrer">CMAK</a>实现。</p><p>先下载<a href="https://github.com/yahoo/CMAK" target="_blank" rel="noopener noreferrer">CMAK</a>已经编译好的安装包。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd /home/work</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; wget https://github.com/yahoo/CMAK/releases/download/3.0.0.6/cmak-3.0.0.6.zip</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; unzip cmak-3.0.0.6.zip</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为<a href="https://github.com/yahoo/CMAK/tree/3.0.0.6" target="_blank" rel="noopener noreferrer">CMAK 3.0.0.6</a>版本明确要求使用<a href="https://www.oracle.com/java/technologies/javase/jdk11-archive-downloads.html" target="_blank" rel="noopener noreferrer">JDK 11</a>，所以这里需要单独下载并解压好<a href="https://www.oracle.com/java/technologies/javase/jdk11-archive-downloads.html" target="_blank" rel="noopener noreferrer">JDK 11</a>。</p><p>然后修改<a href="https://github.com/yahoo/CMAK/tree/3.0.0.6" target="_blank" rel="noopener noreferrer">CMAK 3.0.0.6</a>启动脚本。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd /home/work/cmak-3.0.0.6/bin</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi cmak</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 在文件开始处指定JAVA_HOME</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">JAVA_HOME</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/usr/local/java/jdk-11.0.23</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着再修改它的配置文件。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd /home/work/cmak-3.0.0.6/conf</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi application.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 重新指定一个（这里的zookeeper和kafka集群使用的zookeeper可以不是同一个）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cmak.zkhosts</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;localhost:2181&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为能够在<a href="https://github.com/yahoo/CMAK" target="_blank" rel="noopener noreferrer">CMAK</a>中看到<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>的相关指标，所以要先修改一下<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>的启动命令。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd /home/work/kafka_2.12-3.7.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 先停止服务</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd ./bin/kafka-server-stop.sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 再启动kafka</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">JMX_PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">9527</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ./bin/kafka-server-start.sh</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> config/server.properties</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 或者以守护进程方式启动</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">JMX_PORT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">9527</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ./bin/kafka-server-start.sh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -daemon</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> config/server.properties</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后启动<a href="https://github.com/yahoo/CMAK" target="_blank" rel="noopener noreferrer">CMAK</a>。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd /home/work/cmak-3.0.0.6</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; ./bin/cmak -Dconfig.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">file</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">conf/application.conf</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> -Dhttp.port</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">=9090</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>启动完成后在浏览器中即可访问<a href="http://172.16.185.176:9090" target="_blank" rel="noopener noreferrer">http://172.16.185.176:9090</a>。</p><p>首次启动时<a href="https://github.com/yahoo/CMAK" target="_blank" rel="noopener noreferrer">CMAK</a>中是没有内容的，需要手动添加要管理的<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>节点（单机或集群）。</p><p>只需要用鼠标单击它的<code>Add Cluster</code>，然后选中<code>Enable JMX Polling</code>和<code>Poll consumer information</code>，其他默认不变就行。</p><figure><img src="https://tianmazuo.com/technology/middleware/kafka/kafka-05.png" alt="给CMAK添加集群信息" tabindex="0" loading="lazy"><figcaption>给CMAK添加集群信息</figcaption></figure><p>然后就能看到<a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka</a>的各项信息了。</p><figure><img src="https://tianmazuo.com/technology/middleware/kafka/kafka-06.png" alt="CMAK中显示的Kafka相关信息" tabindex="0" loading="lazy"><figcaption>CMAK中显示的Kafka相关信息</figcaption></figure>`,37);function f(b,u){const i=t("RouteLink");return h(),n("div",null,[k,d,e("p",null,[a("如何实施"),c,a("调优，可以参考我写的"),r(i,{to:"/book/"},{default:l(()=>[a("《Java深度探索：开发基础、高级技术与工程实践》")]),_:1}),a("中"),g,a("的内容。")]),m])}const y=s(p,[["render",f],["__file","optimize.html.vue"]]),F=JSON.parse('{"path":"/technology/middleware/kafka/optimize.html","title":"监控调优","lang":"zh-CN","frontmatter":{"title":"监控调优","icon":"message","category":["中间件","Kafka"],"tag":["中间件","Kafka"],"date":"2023-03-13T00:00:00.000Z","isOriginal":true,"star":true,"description":"JVM参数调优 Kafka的Broker进程默认使用1GB内存。 如何实施JVM调优，可以参考我写的中《第4章 JVM GC》的内容。 知道如何调整和优化JVM GC之后，就可以来修改Kafka的JVM参数了。 这需要根据具体的业务场景和JVM GC压测结果来综合调整。 副本参数调忧 这里主要调整两个参数。 replica.socket.timeout...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/technology/middleware/kafka/optimize.html"}],["meta",{"property":"og:site_name","content":"添码座"}],["meta",{"property":"og:title","content":"监控调优"}],["meta",{"property":"og:description","content":"JVM参数调优 Kafka的Broker进程默认使用1GB内存。 如何实施JVM调优，可以参考我写的中《第4章 JVM GC》的内容。 知道如何调整和优化JVM GC之后，就可以来修改Kafka的JVM参数了。 这需要根据具体的业务场景和JVM GC压测结果来综合调整。 副本参数调忧 这里主要调整两个参数。 replica.socket.timeout..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://tianmazuo.com/technology/middleware/kafka/kafka-05.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"添码座"}],["meta",{"property":"article:tag","content":"中间件"}],["meta",{"property":"article:tag","content":"Kafka"}],["meta",{"property":"article:published_time","content":"2023-03-13T00:00:00.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"监控调优\\",\\"image\\":[\\"https://tianmazuo.com/technology/middleware/kafka/kafka-05.png\\",\\"https://tianmazuo.com/technology/middleware/kafka/kafka-06.png\\"],\\"datePublished\\":\\"2023-03-13T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"添码座\\",\\"url\\":\\"https://www.tianmazuo.com/about/\\"}]}"]]},"headers":[{"level":2,"title":"JVM参数调优","slug":"jvm参数调优","link":"#jvm参数调优","children":[]},{"level":2,"title":"副本参数调忧","slug":"副本参数调忧","link":"#副本参数调忧","children":[]},{"level":2,"title":"Log参数调优","slug":"log参数调优","link":"#log参数调优","children":[]},{"level":2,"title":"Topic命名","slug":"topic命名","link":"#topic命名","children":[]},{"level":2,"title":"监控工具","slug":"监控工具","link":"#监控工具","children":[]}],"git":{},"readingTime":{"minutes":3.27,"words":981},"filePathRelative":"technology/middleware/kafka/optimize.md","localizedDate":"2023年3月13日","excerpt":"<h2>JVM参数调优</h2>\\n<p><a href=\\"https://kafka.apache.org/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Kafka</a>的<code>Broker</code>进程默认使用<code>1GB</code>内存。</p>\\n<p>如何实施<a href=\\"https://zh.wikipedia.org/wiki/Java%E8%99%9A%E6%8B%9F%E6%9C%BA\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">JVM</a>调优，可以参考我写的<a href=\\"/book/\\" target=\\"_blank\\">《Java深度探索：开发基础、高级技术与工程实践》</a>中<code>《第4章 JVM GC》</code>的内容。</p>","autoDesc":true}');export{y as comp,F as data};
