import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as i,o as n,d as a}from"./app-CiwSPZKD.js";const e={},l=a(`<p><a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>是一个简洁、轻量、可扩展的脚本语言，但它并不是基于<a href="https://zh.wikipedia.org/wiki/Java%E8%99%9A%E6%8B%9F%E6%9C%BA" target="_blank" rel="noopener noreferrer">JVM</a>，而是基于<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a>。</p><p>也就是说它是一个可以对<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a>进行编程，从而扩展Web应用的功能，或者对它进行某些定制。例如，在<code>三高</code>（高性能、高可用、高并发）突出的互联网应用中，大多数<code>多级缓存架构</code>中的服务端第一级就是由<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a> + <a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>所组成。</p><figure><img src="https://tianmazuo.com/technology/programming/lua/lua-01.png" alt="Nginx + Lua在多级缓存架构中的位置" tabindex="0" loading="lazy"><figcaption>Nginx + Lua在多级缓存架构中的位置</figcaption></figure><p>这里省略<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a>的安装配置，直接从<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>开始。</p><br><h2 id="安装配置" tabindex="-1"><a class="header-anchor" href="#安装配置"><span>安装配置</span></a></h2><p>先到<a href="https://openresty.org/en/download.html" target="_blank" rel="noopener noreferrer">OpenResty</a>下载安装包（对于<a href="https://www.linux.org" target="_blank" rel="noopener noreferrer">Linux</a>，官方只提供了<a href="https://openresty.org/en/linux-packages.html" target="_blank" rel="noopener noreferrer">预编译</a>的安装包，需要下载后自己编译安装）。</p><p>这里以<a href="https://centos.org/stream9/" target="_blank" rel="noopener noreferrer">CentOS 9</a>为例，官方提供了<a href="https://openresty.org/en/linux-packages.html#centos" target="_blank" rel="noopener noreferrer">预编译安装的相关命令</a>。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># CentOS 9或更高版本执行如下命令</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; wget https://openresty.org/package/centos/openresty2.repo</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; sudo mv openresty2.repo /etc/yum.repos.d/openresty.repo</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># CentOS 8或更高版本执行如下命令</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; wget https://openresty.org/package/centos/openresty.repo</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; sudo mv openresty.repo /etc/yum.repos.d/openresty.repo</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 检查更新</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; sudo yum check-update</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 安装openresty</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; sudo yum install openresty -y</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 安装resty命令行工具</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; sudo yum install openresty-resty -y</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 列出openresty库中所有可用软件包（可选）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; sudo yum </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">--disablerepo</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;*&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --enablerepo</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;openresty&quot;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> list</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> available</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>yum</code>会把<a href="https://openresty.org/" target="_blank" rel="noopener noreferrer">OpenResty</a>安装到<code>/usr/local/openresty</code>目录中，并且它里面还自带了内置的<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a>服务器组件，所以需要把之前可用的<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a>服务停掉，然后将它的配置内容拷贝到<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件中。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd /usr/local/openresty/nginx/conf/</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># openresty下的nginx.conf已经存在了一个备份nginx.conf.default，所以可以直接删除nginx.conf</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; rm -rf nginx.conf</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cp /usr/local/nginx/conf/nginx.conf /usr/local/openresty/nginx/conf/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后再启动<code>/usr/local/openresty</code>下的<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a>服务。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 先验证拷贝过来的配置文件是否能正常启动服务</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; /usr/local/openresty/nginx/sbin/nginx -t</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/openresty/nginx/conf/nginx.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> syntax</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ok</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/openresty/nginx/conf/nginx.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> successful</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 配置无误，启动服务</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; /usr/local/openresty/nginx/sbin/nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了确认是否真的启动了<code>/usr/local/openresty</code>中的<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a>，而不是原本的<code>/usr/local/nginx</code>，可以将<code>/usr/local/openresty/nginx/conf/nginx.conf</code>中的配置稍稍修改一下。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi /usr/local/openresty/nginx/conf/nginx.conf</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">    ......</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        listen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">       9527</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        server_name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  localhost</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        location</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            # 把这里改成/usr/local/openresty/nginx/html，而不是/usr/local/nginx/html，其他地方不变</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   /usr/local/openresty/nginx/html</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            index</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  index.html</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> index.htm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            add_header</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Cache-Control</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;public&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            add_header</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Access-Control-Allow-Origin</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        error_page</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   500</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 502</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 503</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 504</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  /50x.html</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        location</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /50x.html</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   html</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">    ......</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>成功启动后就能看到这个界面了。</p><figure><img src="https://tianmazuo.com/technology/programming/lua/lua-02.png" alt="OpenResty首页" tabindex="0" loading="lazy"><figcaption>OpenResty首页</figcaption></figure><p>官方同时也提供了<a href="https://hub.docker.com/r/openresty/openresty" target="_blank" rel="noopener noreferrer">Docker部署</a>方式，但相对于<a href="https://www.docker.com" target="_blank" rel="noopener noreferrer">Docker</a>，初学阶段还是用本机安装的方式比较合适，因为会在<a href="https://openresty.org/" target="_blank" rel="noopener noreferrer">OpenResty</a>服务器中创建和修改大量的<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>脚本文件。</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>后续所有相关提到<code>nginx.conf</code>配置文件的地方，指的都是<a href="https://openresty.org/" target="_blank" rel="noopener noreferrer">OpenResty</a>中的<code>nginx.conf</code>，也就是<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，而不是<code>/usr/local/nginx/conf/nginx.conf</code>。</p></div><br><h2 id="小栗子" tabindex="-1"><a class="header-anchor" href="#小栗子"><span>小栗子</span></a></h2><p>搭建好了<a href="https://openresty.org/" target="_blank" rel="noopener noreferrer">OpenResty</a>就可以来写一个<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>的小栗子了。</p><p>编辑<code>nginx.conf</code>配置文件，添加一些内容。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi /usr/local/openresty/nginx/conf/nginx.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># http部分中添加如下内容</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lua_package_path</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;/usr/local/openresty/lualib/?.lua;;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">#lua模块</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lua_package_cpath</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;/usr/local/openresty/lualib/?.so;;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">#c模块</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lua.conf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后临时在<code>/usr/local/openresty/nginx/conf</code>目录中创建<code>lua.conf</code>文件，内容如下。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi /usr/local/openresty/nginx/conf/lua.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    listen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 9527</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    server_name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> _</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    location</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /lua</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        default_type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;text/html&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        content_by_lua</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;ngx.say(&quot;hello lua&quot;)&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者使用<code>content_by_lua_block</code>的方式。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi /usr/local/openresty/nginx/conf/lua.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    listen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 9527</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    server_name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> _</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    location</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /lua</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        default_type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;text/html&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        content_by_lua_block</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            &#39;ngx.say(&quot;hello lua&quot;)&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>保存退出后测试配置是否正常，如果正常就重启服务器。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; /usr/local/openresty/nginx/sbin/nginx -t</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/openresty/nginx/conf/nginx.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> syntax</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ok</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/openresty/nginx/conf/nginx.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> successful</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 重启openresty</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; /usr/local/openresty/nginx/sbin/nginx -s reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后通过浏览器访问<a href="http://xn--IP-fr5c86lw2a0cw16k:9527/lua" target="_blank" rel="noopener noreferrer">http://服务器IP地址:9527/lua</a>就能看到打出来的内容<code>hello lua</code>。</p><br><h2 id="代码组织" tabindex="-1"><a class="header-anchor" href="#代码组织"><span>代码组织</span></a></h2><p>将<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>脚本内容直接放在<code>lua.conf</code>文件中会带来维护不便的问题，所以可以参照许多编程语言中对代码包<code>package</code>的组织方式，将配置和执行部分分离。</p><figure><img src="https://tianmazuo.com/technology/programming/lua/lua-03.png" alt="Lua分包组织" tabindex="0" loading="lazy"><figcaption>Lua分包组织</figcaption></figure><p>修改之前<code>lua.conf</code>的内容。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi /usr/local/openresty/nginx/conf/lua.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    listen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 9527</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    server_name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> _</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    location</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /lua</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        default_type</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;text/html&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        content_by_lua_file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> conf/lua/hello.lua</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        lua_code_cache</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>/usr/local/openresty/nginx/conf/</code>目录中创建<code>lua</code>文件夹，并在其中创建一个名为<code>hello.lua</code>的文件，然后输入下面的内容。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd /usr/local/openresty/nginx/conf/</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; mkdir lua</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; cd lua</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; vi hello.lua</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ngx.say(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;Hello Lua from conf/lua/hello.lua&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>保存退出后测试配置是否正常，如果正常就重启服务器。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; /usr/local/openresty/nginx/sbin/nginx -t</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/openresty/nginx/conf/nginx.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> syntax</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ok</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/openresty/nginx/conf/nginx.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> successful</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"># 重启openresty</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; /usr/local/openresty/nginx/sbin/nginx -s reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后通过浏览器访问<a href="http://xn--IP-fr5c86lw2a0cw16k:9527/lua" target="_blank" rel="noopener noreferrer">http://服务器IP地址:9527/lua</a>就能看到打出来的内容<code>Hello Lua from conf/lua/hello.lua</code>。</p><br><h2 id="开发环境" tabindex="-1"><a class="header-anchor" href="#开发环境"><span>开发环境</span></a></h2><p>如果开发一个<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>脚本文件需要不断地测试和重启<a href="https://openresty.org/" target="_blank" rel="noopener noreferrer">OpenResty</a>中的<a href="https://www.nginx.org/" target="_blank" rel="noopener noreferrer">Nginx</a>，是相当麻烦，也费力不讨好的事情，这个问题可以通过两种方式解决。</p><ul><li><p>第一种方式：通过<a href="https://www.jetbrains.com/idea/" target="_blank" rel="noopener noreferrer">IDEA</a> + <a href="https://github.com/rjpcomputing/luaforwindows/releases" target="_blank" rel="noopener noreferrer">Lua for Windows</a> + <a href="https://plugins.jetbrains.com/plugin/9768-emmylua" target="_blank" rel="noopener noreferrer">EmmyLua</a>插件解决（从名字就知道它只支持<a href="https://www.microsoft.com/en-us/windows" target="_blank" rel="noopener noreferrer">Windows</a>）。</p><ul><li><p>傻瓜式安装<a href="https://github.com/rjpcomputing/luaforwindows/releases" target="_blank" rel="noopener noreferrer">Lua for Windows</a>，一路<code>next</code>就行了。</p></li><li><p>在<a href="https://www.jetbrains.com/idea/" target="_blank" rel="noopener noreferrer">IDEA</a>中安装<a href="https://plugins.jetbrains.com/plugin/9768-emmylua" target="_blank" rel="noopener noreferrer">EmmyLua</a>插件，安装好之后重启。</p></li><li><p>新建一个<a href="https://maven.apache.org" target="_blank" rel="noopener noreferrer">Maven</a>项目，再新建<code>test.lua</code>文件，可以通过两种方式运行它：直接单击鼠标右键，在弹出的面板中选择<code>Run &#39;test.lua&#39;</code>，或者通过<code>Edit Configurations...</code>的方式运行。</p></li></ul><figure><img src="https://tianmazuo.com/technology/programming/lua/lua-04.png" alt="两种运行lua脚本的方式" tabindex="0" loading="lazy"><figcaption>两种运行lua脚本的方式</figcaption></figure><ul><li>如果是<code>Edit Configurations...</code>的话，一般会这样配置。</li></ul><figure><img src="https://tianmazuo.com/technology/programming/lua/lua-05.png" alt="通过方式运行" tabindex="0" loading="lazy"><figcaption>通过<code>Edit Configurations...</code>方式运行</figcaption></figure></li><li><p>第二种方式：使用<a href="https://github.com/pkulchenko/ZeroBraneStudio" target="_blank" rel="noopener noreferrer">ZeroBraneStudio</a>编辑器（<a href="https://www.microsoft.com/en-us/windows" target="_blank" rel="noopener noreferrer">Windows</a>、<a href="https://www.linux.org/" target="_blank" rel="noopener noreferrer">Linux</a>和<a href="https://www.apple.com/macos/sonoma/" target="_blank" rel="noopener noreferrer">Mac OS</a>它全都支持）。</p></li></ul><p>在<a href="https://studio.zerobrane.com/download?not-this-time" target="_blank" rel="noopener noreferrer">这里</a>可以下载不同操作系统环境的安装包，下载后直接安装就行了。</p><figure><img src="https://tianmazuo.com/technology/programming/lua/lua-06.png" alt="使用ZeroBraneStudio调试lua脚本" tabindex="0" loading="lazy"><figcaption>使用ZeroBraneStudio调试lua脚本</figcaption></figure><p>这个<a href="https://en.wikipedia.org/wiki/Integrated_development_environment" target="_blank" rel="noopener noreferrer">IDE</a>非常小（<a href="https://www.apple.com/macos/sonoma/" target="_blank" rel="noopener noreferrer">Mac OS</a>的安装包还不到<code>10MB</code>），它就是为调试<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>而诞生的。</p><p>这两种方式完全视个人习惯而定。</p>`,50),t=[l];function r(h,p){return n(),i("div",null,t)}const d=s(e,[["render",r],["__file","index.html.vue"]]),g=JSON.parse('{"path":"/technology/programming/lua/","title":"环境搭建","lang":"zh-CN","frontmatter":{"title":"环境搭建","icon":"scroll","category":["编程语言","LUA"],"tag":["编程语言","LUA"],"date":"2023-02-17T00:00:00.000Z","isOriginal":true,"star":true,"description":"Lua是一个简洁、轻量、可扩展的脚本语言，但它并不是基于JVM，而是基于Nginx。 也就是说它是一个可以对Nginx进行编程，从而扩展Web应用的功能，或者对它进行某些定制。例如，在三高（高性能、高可用、高并发）突出的互联网应用中，大多数多级缓存架构中的服务端第一级就是由Nginx + Lua所组成。 Nginx + Lua在多级缓存架构中的位置Ng...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/technology/programming/lua/"}],["meta",{"property":"og:site_name","content":"添码座"}],["meta",{"property":"og:title","content":"环境搭建"}],["meta",{"property":"og:description","content":"Lua是一个简洁、轻量、可扩展的脚本语言，但它并不是基于JVM，而是基于Nginx。 也就是说它是一个可以对Nginx进行编程，从而扩展Web应用的功能，或者对它进行某些定制。例如，在三高（高性能、高可用、高并发）突出的互联网应用中，大多数多级缓存架构中的服务端第一级就是由Nginx + Lua所组成。 Nginx + Lua在多级缓存架构中的位置Ng..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://tianmazuo.com/technology/programming/lua/lua-01.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"添码座"}],["meta",{"property":"article:tag","content":"编程语言"}],["meta",{"property":"article:tag","content":"LUA"}],["meta",{"property":"article:published_time","content":"2023-02-17T00:00:00.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"环境搭建\\",\\"image\\":[\\"https://tianmazuo.com/technology/programming/lua/lua-01.png\\",\\"https://tianmazuo.com/technology/programming/lua/lua-02.png\\",\\"https://tianmazuo.com/technology/programming/lua/lua-03.png\\",\\"https://tianmazuo.com/technology/programming/lua/lua-04.png\\",\\"https://tianmazuo.com/technology/programming/lua/lua-05.png\\",\\"https://tianmazuo.com/technology/programming/lua/lua-06.png\\"],\\"datePublished\\":\\"2023-02-17T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"添码座\\",\\"url\\":\\"https://www.tianmazuo.com/about/\\"}]}"]]},"headers":[{"level":2,"title":"安装配置","slug":"安装配置","link":"#安装配置","children":[]},{"level":2,"title":"小栗子","slug":"小栗子","link":"#小栗子","children":[]},{"level":2,"title":"代码组织","slug":"代码组织","link":"#代码组织","children":[]},{"level":2,"title":"开发环境","slug":"开发环境","link":"#开发环境","children":[]}],"git":{},"readingTime":{"minutes":5.03,"words":1509},"filePathRelative":"technology/programming/lua/README.md","localizedDate":"2023年2月17日","excerpt":"<p><a href=\\"https://www.lua.org/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Lua</a>是一个简洁、轻量、可扩展的脚本语言，但它并不是基于<a href=\\"https://zh.wikipedia.org/wiki/Java%E8%99%9A%E6%8B%9F%E6%9C%BA\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">JVM</a>，而是基于<a href=\\"https://www.nginx.org/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Nginx</a>。</p>","autoDesc":true}');export{d as comp,g as data};
